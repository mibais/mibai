import{x as y,a as N}from"./index-DcB7UUez.js";import{d as w,a5 as S,a3 as g,s as q,f as _,o as E,k as c,ad as m,u as v,F as R}from"./vue-DZ3ObLO4.js";import{H as A,aF as C,aT as D,as as F}from"./antd-CHYaqX98.js";var d=(a=>(a.alipay="alipay",a))(d||{});const U={alipay:T};function I(a){return y("/payment/process",a,{customDev:!0})}function O(a){return y("/payment/payStatus",{tradeNo:a},{customDev:!0})}function $(a){return y("/payment/createOrder",a,{customDev:!0})}const B=w({__name:"index",emits:["receiveMsg"],setup(a,{expose:l,emit:o}){const r=o;async function i(s){var t;if(window.EventSource){const f=(t=N().userInfo)==null?void 0:t.id,p=new EventSource(`http://127.0.0.1:8080/api/sse/create/chargeEvent?tradeNo=${s}&userId=${f}`);console.log("sse connect success"),p.onmessage=function(n){console.log("后端返回的数据:",n),n.data&&r("receiveMsg",n.data)},p.onerror=n=>{console.log("sse connect fail: ",n)}}else console.log("your bowser not support sse yet. /(ㄒoㄒ)/~~")}return l({createSse:i}),(s,t)=>(S(),g("div"))}}),T=w({__name:"alipay-qrcode",props:{payPrice:{type:Number,required:!0}},emits:["close"],setup(a,{emit:l}){const o=a,r=l,i=q(),s=_(""),t=_(""),u=_(!1);async function f(){const{data:e}=await $({type:d.alipay,payPrice:o.payPrice});t.value=e}async function p(){await i.value.createSse(t.value)}async function n(){u.value=!0,await f(),await p();const{data:e}=await I({type:d.alipay,payPrice:o.payPrice,tradeNo:t.value});s.value=e,u.value=!1}function h(e){console.log("二维码页收到消息：",e),e!=null&&e.charge&&(e==null?void 0:e.payPrice)===o.payPrice&&r("close",!0)}async function P(){const{data:e}=await O(t.value);["paid","finished"].includes(e)&&r("close",!0)}return E(()=>{n()}),(e,z)=>{const k=A,x=C,b=D,M=F;return S(),g(R,null,[c(B,{ref_key:"sseRef",ref:i,onReceiveMsg:h},null,512),c(M,{open:!0,"ok-text":"已支付",keyboard:!1,"mask-closable":!1,closable:!1,width:320,"cancel-button-props":{disabled:!0},title:"支付宝扫码支付",onOk:P},{default:m(()=>[c(k,{type:"warning",message:"支付成功后页面长时间无响应请点击已支付按钮"}),c(b,{spinning:v(u),tip:"付款码正在加载中"},{default:m(()=>[c(x,{size:270,value:v(s)},null,8,["value"])]),_:1},8,["spinning"])]),_:1})],64)}}});export{d as P,T as _,U as p};
